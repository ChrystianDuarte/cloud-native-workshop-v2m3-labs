apiVersion: maistra.io/v1
kind: ServiceMeshControlPlane
metadata:
  name: istio-installation
spec:
  # NOTE, if you remove all children from an element, you should remove the
  # element too.  An empty element is interpreted as null and will override all
  # default values (i.e. no values will be specified for that element, not even
  # the defaults baked into the chart values.yaml).
  istio:
    multitenant: false
    launcher:
      enabled: false
    # nodeagent:
    #   enabled: false
    #   image: docker.io/istio/node-agent-k8s:1.1.9
    #   env:
    #     CA_PROVIDER: "Citadel"
    #     CA_ADDR: "istio-citadel:8060"
    #     VALID_TOKEN: true
    global:
      # force to use rhel7 based proxy-init container
      proxy_init:
        image: proxy-init
      hub: registry.redhat.io/openshift-istio-tech-preview
      tag: 0.11.1
      # the following lines enable tls across the control and data planes
      controlPlaneSecurityEnabled: true
      mtls:
        enabled: true
      disablePolicyChecks: false
      policyCheckFailOpen: false
      outboundTrafficPolicy:
        mode: REGISTRY_ONLY # defaults to ALLOW_ANY
      proxy:
        accessLogFile: /dev/stdout # in envs higher than test this should be empty
        accessLogEncoding: TEXT
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 128Mi
      # sds:
      #   enabled: false
      #   udsPath: "unix:/var/run/sds/uds_path" #just a test to see if we pass the selinux hurdle
      #   useNormalJwt: true
    gateways:
      istio-egressgateway:
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 128Mi
        autoscaleEnabled: true
        autoscaleMin: 3
        autoscaleMax: 5
        # sds:
        #   enabled: true
        #   image: docker.io/istio/node-agent-k8s:1.1.9
      istio-ingressgateway:
        autoscaleEnabled: true
        autoscaleMin: 3
        autoscaleMax: 5
        ior_enabled: false
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 128Mi
        # sds:
        #   enabled: false
        #   image: docker.io/istio/node-agent-k8s:1.1.9
    mixer:
      policy:
        autoscaleEnabled: true
        autoscaleMin: 3
        autoscaleMax: 5
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 128Mi
      telemetry:
        autoscaleEnabled: true
        autoscaleMin: 3
        autoscaleMax: 5
        resources:
          requests:
            cpu: 100m
            memory: 1G
          limits:
            cpu: 500m
            memory: 4G
    pilot:
      autoscaleEnabled: true
      traceSampling: 100.0
      autoscaleMin: 3
      autoscaleMax: 5
      resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 128Mi
    kiali:
      enabled: true
      tag: 0.20.0
    tracing:
      enabled: true
      hub: distributed-tracing-tech-preview
      tag: 1.11
